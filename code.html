<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Code Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      color-scheme: light dark;

      --bg-color: #f3f3f3;
      --text-color: #1e1e1e;
      --panel-bg: #ffffff;
      --border-color: #d0d0d0;
      --accent-color: #007acc;
      --accent-soft: rgba(0, 122, 204, 0.1);
      --editor-bg: #ffffff;
      --editor-text: #1e1e1e;
      --output-bg: #f3f3f3;
      --scrollbar-bg: #c8c8c8;
      --scrollbar-thumb: #888888;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1e1e1e;
        --text-color: #d4d4d4;
        --panel-bg: #252526;
        --border-color: #3c3c3c;
        --accent-color: #0e639c;
        --accent-soft: rgba(14, 99, 156, 0.25);
        --editor-bg: #1e1e1e;
        --editor-text: #d4d4d4;
        --output-bg: #1e1e1e;
        --scrollbar-bg: #2a2a2a;
        --scrollbar-thumb: #555555;
      }
    }

    * {
      box-sizing: border-box;
    }

    html {
      font-size: 115%;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 1rem;
    }

    h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1.9rem;
      letter-spacing: 0.03em;
    }

    h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }

    .panel-title {
      margin: 0 0 0.5rem 0;
      font-size: 1.1rem;
      font-weight: 600;
      display: block;
      color: inherit;
    }

    .page {
      width: 100%;
      max-width: none;
      margin: 0 auto;
      padding: 1rem 1.5rem 2rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(360px, 400px) minmax(0, 1fr) minmax(0, 1fr);
      gap: 1rem;
      align-items: stretch;
    }

    @media (max-width: 1200px) {
      .layout {
        grid-template-columns: minmax(360px, 400px) minmax(0, 1fr);
      }
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background-color: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 0.75rem 0.8rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.18);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .small-label {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    textarea {
      width: 100%;
      height: 6rem;
      resize: none;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      padding: 0.4rem 0.5rem;
      font-family: "JetBrains Mono", "SF Mono", Menlo, Monaco, Consolas, monospace;
      font-size: 0.95rem;
      background-color: var(--editor-bg);
      color: var(--editor-text);
      overflow: auto;
    }

    .vars textarea {
      background-color: var(--editor-bg);
      color: var(--editor-text);
    }

    textarea:focus,
    input:focus,
    select:focus {
      outline: 1px solid var(--accent-color);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .vars-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .hint {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-bottom: 0.4rem;
    }

    .editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.4rem;
    }

    .editor-label {
      display: flex;
      flex-direction: column;
    }

    .placeholder-config {
      margin-top: 0.6rem;
      border-top: 1px solid var(--border-color);
      padding-top: 0.6rem;
    }

    .placeholder-rows {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      margin-top: 0.3rem;
    }

    .placeholder-row {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 0.4rem;
      align-items: center;
    }

    .placeholder-row input,
    .placeholder-row select {
      width: 100%;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      padding: 0.25rem 0.4rem;
      font-size: 0.93rem;
      font-family: "JetBrains Mono", "SF Mono", Menlo, Monaco, Consolas, monospace;
      background-color: var(--editor-bg);
      color: var(--editor-text);
    }
    
    input,
    select {
      background-color: var(--editor-bg);
      color: var(--editor-text);
    }

    .actions {
      margin-top: 0.7rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .actions-stack {
      flex-direction: column;
      align-items: flex-start;
      flex-wrap: nowrap;
    }

    button {
      border-radius: 4px;
      border: 1px solid var(--accent-color);
      background-color: var(--accent-color);
      color: #ffffff;
      padding: 0.35rem 0.9rem;
      font-size: 0.9rem;
      cursor: pointer;
      font-family: inherit;
    }

    button:hover {
      filter: brightness(1.05);
    }

    button:active {
      filter: brightness(0.95);
    }

    .primary-button {
      background-color: #1f9a4b;
      border-color: #1f9a4b;
    }

    .status-row {
      margin-top: 0.35rem;
      min-height: 1.2rem;
    }

    .status {
      font-size: 0.8rem;
      min-height: 1.1em;
    }

    .status.error {
      color: #c74e39;
    }

    .status.ok {
      color: #6a9955;
    }

    .output-panel {
      margin-top: 1rem;
      background-color: var(--editor-bg);
      border-radius: 6px;
      border: 1px solid var(--border-color);
      padding: 0.5rem 0.6rem;
      max-height: 24rem;
      overflow: auto;
    }

    .output-panel::-webkit-scrollbar {
      width: 10px;
      height: 10px;
      background-color: var(--scrollbar-bg);
    }

    .output-panel::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
    }

    .code-block {
      border-radius: 4px;
      margin-bottom: 0.6rem;
      border: 1px solid rgba(255, 255, 255, 0.04);
      background-color: #1e1e1e;
      color: #d4d4d4;
    }

    @media (prefers-color-scheme: light) {
      .code-block {
        background-color: #f5f5f5;
        color: #1e1e1e;
      }
    }

    .code-block-header {
      font-size: 0.8rem;
      padding: 0.2rem 0.45rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.18);
      background: linear-gradient(to right, rgba(0, 0, 0, 0.12), transparent);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .code-block-header span {
      opacity: 0.9;
    }

    .copy-button {
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 3px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background-color: transparent;
      color: inherit;
    }

    .copy-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    pre {
      margin: 0;
      padding: 0.35rem 0.45rem 0.45rem;
      overflow-x: auto;
      font-size: 0.93rem;
    }

    code {
      font-family: "JetBrains Mono", "SF Mono", Menlo, Monaco, Consolas, monospace;
      white-space: pre;
    }

    .footer-hint {
      margin-top: 0.4rem;
      font-size: 0.75rem;
      opacity: 0.75;
    }

    /* Syntax Highlight + Editor Overlay */
    .editor-wrapper {
      position: relative;
      min-height: 18rem;
      flex: 1;
    }

    .editor-wrapper textarea,
    .editor-wrapper pre {
      font-family: "JetBrains Mono", "SF Mono", Menlo, Monaco, Consolas, monospace;
      font-size: 0.94rem;
      line-height: 1.4;
      tab-size: 3;
    }

    .code-input {
      position: relative;
      z-index: 2;
      background: transparent;
      color: var(--editor-text);
      caret-color: var(--editor-text);
      height: 100%;
      min-height: 18rem;
      white-space: pre;
      overflow: auto;
    }

    .code-input.overlay-active {
      color: transparent;
      text-shadow: none;
    }

    .code-highlight {
      position: absolute;
      inset: 0;
      margin: 0;
      padding: 0.4rem 0.5rem;
      background: var(--editor-bg);
      color: var(--editor-text);
      border-radius: 4px;
      overflow: auto;
      white-space: pre;
      overflow-wrap: normal;
      word-break: normal;
      pointer-events: none;
      z-index: 1;
    }

    .code-highlight::selection {
      background: transparent;
    }

    /* Token colors */
    .st-keyword { color: #569cd6; }
    .st-type { color: #4ec9b0; }
    .st-number { color: #b5cea8; }
    .st-string { color: #ce9178; }
    .st-comment { color: #6a9955; }
    .st-operator { color: #dcdcaa; }

    @media (prefers-color-scheme: light) {
      .st-keyword { color: #005cc5; }
      .st-type { color: #0b9a83; }
      .st-number { color: #216e39; }
      .st-string { color: #9c2c2c; }
      .st-comment { color: #3b7a57; }
      .st-operator { color: #8b6f00; }
    }

    .ws-space,
    .ws-tab {
      position: relative;
      color: transparent;
    }

    .ws-space::after {
      content: "·";
      color: rgba(128, 128, 128, 0.7);
      position: absolute;
      inset: 0;
      pointer-events: none;
      text-align: center;
    }

    .ws-tab {
      display: inline-block;
      width: 3ch;
    }

    .ws-tab::after {
      content: "→";
      color: rgba(128, 128, 128, 0.85);
      position: absolute;
      inset: 0;
      pointer-events: none;
      text-align: center;
    }

    .footer-panel {
      margin-top: 1.2rem;
      padding: 0.9rem 1rem;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    }

    .footer-note {
      font-size: 0.9rem;
      color: #777777;
      margin: 0 0 0.3rem 0;
    }

    .license-note {
      font-size: 0.82rem;
      color: #777777;
      margin: 0;
    }

    @media (prefers-color-scheme: dark) {
      .footer-note,
      .license-note {
        color: #9ca3af;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Code Generator</h1>
    <p class="hint">
      Links definierst du bis zu vier Variablenlisten, in der Mitte schreibst du die Codevorlage und rechts erscheinen die generierten Codeblöcke.
      Aus den Zeilen der Variablen werden entsprechend viele Blöcke erzeugt.
    </p>

    <div class="layout">
      <!-- Linke Seite: Variablen -->
      <div class="panel vars">
        <h2 class="panel-title">Variablen</h2>
        <p class="hint">
          Pro Zeile genau ein Wort oder Eintrag.
          In allen ausgefüllten Feldern muss die gleiche Anzahl Zeilen stehen.
        </p>
          <div class="vars-group">
            <div>
              <label for="variable_1">Variablenliste 1</label>
              <textarea id="variable_1" placeholder="Hier Variablenliste einfügen..."></textarea>
            </div>
            <div>
              <label for="variable_2">Variablenliste 2</label>
              <textarea id="variable_2" placeholder="Hier Variablenliste einfügen..."></textarea>
            </div>
            <div>
              <label for="variable_3">Variablenliste 3</label>
              <textarea id="variable_3" placeholder="Hier Variablenliste einfügen..."></textarea>
            </div>
            <div>
              <label for="variable_4">Variablenliste 4</label>
              <textarea id="variable_4" placeholder="Hier Variablenliste einfügen..."></textarea>
            </div>
          </div>

        <div class="actions">
          <button id="clear-vars">Variablen leeren</button>
        </div>
      </div>

      <!-- Mitte: Editor und Platzhalter -->
      <div class="panel editor-panel">
        <div class="editor-header">
          <div class="editor-label">
            <label for="template" class="panel-title">Codevorlage</label>
            <span class="small-label">
              Verwende feste Platzhalterwörter, die unten zugeordnet werden.
            </span>
          </div>
        </div>

        <div class="editor-wrapper">
          <pre id="template-highlight" class="code-highlight" aria-hidden="true"></pre>
          <textarea id="template" class="code-input" wrap="off"
            placeholder="Beispiel:&#10;const name = PLACEHOLDER_NAME;&#10;const wert = PLACEHOLDER_WERT;&#10;const farbe = PLACEHOLDER_FARBE;"></textarea>
        </div>

        <div class="placeholder-config">
          <div class="editor-header">
            <div>
              <span class="small-label">
                Platzhalter Konfiguration maximal vier Wörter
              </span>
            </div>
          </div>

          <div class="placeholder-rows">
            <div class="placeholder-row">
              <input id="ph1-text" type="text" placeholder="Strg/Cmd+1 zum Befüllen">
              <select id="ph1-source">
                <option value="variable_1">Variablenliste 1</option>
                <option value="variable_2">Variablenliste 2</option>
                <option value="variable_3">Variablenliste 3</option>
                <option value="variable_4">Variablenliste 4</option>
              </select>
            </div>
            <div class="placeholder-row">
              <input id="ph2-text" type="text" placeholder="Strg/Cmd+2 zum Befüllen">
              <select id="ph2-source">
                <option value="variable_1">Variablenliste 1</option>
                <option value="variable_2">Variablenliste 2</option>
                <option value="variable_3">Variablenliste 3</option>
                <option value="variable_4">Variablenliste 4</option>
              </select>
            </div>
            <div class="placeholder-row">
              <input id="ph3-text" type="text" placeholder="Strg/Cmd+3 zum Befüllen">
              <select id="ph3-source">
                <option value="variable_1">Variablenliste 1</option>
                <option value="variable_2">Variablenliste 2</option>
                <option value="variable_3">Variablenliste 3</option>
                <option value="variable_4">Variablenliste 4</option>
              </select>
            </div>
            <div class="placeholder-row">
              <input id="ph4-text" type="text" placeholder="Strg/Cmd+4 zum Befüllen">
              <select id="ph4-source">
                <option value="variable_1">Variablenliste 1</option>
                <option value="variable_2">Variablenliste 2</option>
                <option value="variable_3">Variablenliste 3</option>
                <option value="variable_4">Variablenliste 4</option>
              </select>
            </div>
          </div>

          <div class="actions actions-stack">
            <button id="generate" class="primary-button">Code generieren</button>
            <button id="clear-editor">Editor &amp; Ausgabe leeren</button>
          </div>
          <div class="status-row">
            <div id="status" class="status"></div>
          </div>
        </div>
      </div>

      <!-- Rechte Seite: Ausgabe -->
      <div class="panel">
        <h2 class="panel-title">Codeblöcke</h2>
        <p class="hint">
          Generierte Blöcke erscheinen hier; kopiere alles oder einzelne Blöcke.
        </p>

        <div class="actions">
          <button id="copy-all">Alle Codeblöcke kopieren</button>
        </div>

        <div class="output-panel" id="output">
          <!-- Generierte Codeblöcke erscheinen hier -->
        </div>

        <div class="footer-hint">
          Hinweis: Es wird ein Codeblock pro Zeile in den Variablenfeldern erzeugt.
        </div>
      </div>
    </div>

  <div class="footer-panel">
    <p class="license-note">
      Dieser Generator wurde durch vibe coding erstellt. Hinweis: Der Generator kann unkontrolliert Dinge tun; ich habe nicht den ganzen Code gelesen.
    </p>
  </div>
</div>

  <script>
    function parseLines(textareaId) {
      const raw = document.getElementById(textareaId).value || "";
      return raw
        .split(/\r?\n/)
        .map(line => line.trim())
        .filter(line => line.length > 0);
    }

    function escapeRegExp(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function replaceAllLiteral(text, search, replacement) {
      if (!search) {
        return text;
      }
      const pattern = new RegExp(escapeRegExp(search), "g");
      return text.replace(pattern, replacement);
    }

    const ST_KEYWORDS = new Set([
      "PROGRAM", "END_PROGRAM", "FUNCTION", "END_FUNCTION",
      "FUNCTION_BLOCK", "END_FUNCTION_BLOCK",
      "VAR", "VAR_INPUT", "VAR_OUTPUT", "VAR_IN_OUT", "VAR_TEMP", "VAR_GLOBAL", "VAR_EXTERNAL", "END_VAR",
      "IF", "THEN", "ELSE", "ELSIF", "END_IF",
      "FOR", "TO", "BY", "DO", "END_FOR",
      "WHILE", "END_WHILE",
      "REPEAT", "UNTIL", "END_REPEAT",
      "CASE", "OF", "END_CASE",
      "RETURN", "EXIT",
      "WITH", "AND", "OR", "XOR", "NOT", "MOD", "DIV",
      "TYPE", "END_TYPE", "STRUCT", "END_STRUCT",
      "METHOD", "END_METHOD", "PROPERTY", "END_PROPERTY",
      "PRIVATE", "PUBLIC", "PROTECTED", "CONST"
    ]);

    const ST_TYPES = new Set([
      "BOOL", "BYTE", "WORD", "DWORD", "LWORD",
      "SINT", "INT", "DINT", "LINT",
      "USINT", "UINT", "UDINT", "ULINT",
      "REAL", "LREAL",
      "STRING", "WSTRING",
      "TIME", "DATE", "TIME_OF_DAY", "DATE_AND_TIME", "TOD", "DT"
    ]);

    function escapeHtml(str) {
      return (str || "").replace(/[&<>"]/g, ch => {
        switch (ch) {
          case "&": return "&amp;";
          case "<": return "&lt;";
          case ">": return "&gt;";
          case "\"": return "&quot;";
          default: return ch;
        }
      });
    }

    function renderWhitespace(html, showWhitespace) {
      if (!showWhitespace) {
        return html;
      }
      return html
        .replace(/ /g, "<span class=\"ws-space\"> </span>")
        .replace(/\t/g, "<span class=\"ws-tab\">\t</span>");
    }

    function wrapToken(content, className) {
      return `<span class="${className}">${content}</span>`;
    }

    function classifyToken(token) {
      const upper = token.toUpperCase();
      if (token.startsWith("(*") || token.startsWith("//")) {
        return "st-comment";
      }
      if (token.startsWith("\"")) {
        return "st-string";
      }
      if (ST_KEYWORDS.has(upper)) {
        return "st-keyword";
      }
      if (ST_TYPES.has(upper)) {
        return "st-type";
      }
      if (/^(?:\d[\d_]*(?:\.\d[\d_]*)?|(?:16#|2#|8#|10#)[0-9A-Fa-f_]+)$/.test(token)) {
        return "st-number";
      }
      if (/^(:=|<=|>=|<>)$/.test(token)) {
        return "st-operator";
      }
      return "";
    }

    function highlightStructuredText(source, options = {}) {
      const showWhitespace = Boolean(options.showWhitespace);
      const pieces = [];
      const pattern = /(\(\*[\s\S]*?\*\)|\/\/[^\n]*|"(?:[^"\\]|\\.)*"|\b[A-Za-z_][A-Za-z0-9_]*\b|:=|<=|>=|<>|\b\d[\d_]*(?:\.\d[\d_]*)?\b|(?:16#|2#|8#|10#)[0-9A-Fa-f_]+)/g;
      let lastIndex = 0;

      source = source || "";

      source.replace(pattern, (match, _g, offset) => {
        if (offset > lastIndex) {
          const plain = source.slice(lastIndex, offset);
          pieces.push(renderWhitespace(escapeHtml(plain), showWhitespace));
        }

        const className = classifyToken(match);
        const safe = renderWhitespace(escapeHtml(match), showWhitespace);
        pieces.push(className ? wrapToken(safe, className) : safe);

        lastIndex = offset + match.length;
        return match;
      });

      if (lastIndex < source.length) {
        const plain = source.slice(lastIndex);
        pieces.push(renderWhitespace(escapeHtml(plain), showWhitespace));
      }

      return pieces.join("");
    }

    function updateTemplateHighlight() {
      const textarea = document.getElementById("template");
      const highlight = document.getElementById("template-highlight");
      const content = textarea.value || "";
      highlight.innerHTML = highlightStructuredText(content, { showWhitespace: true });
    }

    function syncTemplateScroll() {
      const textarea = document.getElementById("template");
      const highlight = document.getElementById("template-highlight");
      highlight.scrollTop = textarea.scrollTop;
      highlight.scrollLeft = textarea.scrollLeft;
    }

    function insertSelectionIntoPlaceholder(index) {
      const textarea = document.getElementById("template");
      const placeholderInput = document.getElementById("ph" + index + "-text");
      if (!textarea || !placeholderInput) {
        return false;
      }

      const selection = textarea.value.slice(textarea.selectionStart, textarea.selectionEnd).trim();
      if (!selection) {
        showStatus("Bitte zuerst Text im Editor markieren.", true);
        return false;
      }

      placeholderInput.value = selection;
      placeholderInput.placeholder = selection;
      persistState();
      showStatus("Platzhalter " + index + " mit markiertem Text gefüllt.", false);
      return true;
    }

    const STORAGE_KEY = "code_generator_state_v1";

    function persistState() {
      try {
        const state = {
          template: document.getElementById("template").value || "",
          variables: {
            variable_1: document.getElementById("variable_1").value || "",
            variable_2: document.getElementById("variable_2").value || "",
            variable_3: document.getElementById("variable_3").value || "",
            variable_4: document.getElementById("variable_4").value || ""
          },
          placeholders: [
            { text: document.getElementById("ph1-text").value || "", source: document.getElementById("ph1-source").value },
            { text: document.getElementById("ph2-text").value || "", source: document.getElementById("ph2-source").value },
            { text: document.getElementById("ph3-text").value || "", source: document.getElementById("ph3-source").value },
            { text: document.getElementById("ph4-text").value || "", source: document.getElementById("ph4-source").value }
          ]
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        // Ignore storage errors (e.g., private mode).
      }
    }

    function restoreState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const state = JSON.parse(raw);

        if (state.template !== undefined) {
          document.getElementById("template").value = state.template;
        }

        if (state.variables) {
          document.getElementById("variable_1").value = state.variables.variable_1 || "";
          document.getElementById("variable_2").value = state.variables.variable_2 || "";
          document.getElementById("variable_3").value = state.variables.variable_3 || "";
          document.getElementById("variable_4").value = state.variables.variable_4 || "";
        }

        if (Array.isArray(state.placeholders)) {
          const ids = ["ph1", "ph2", "ph3", "ph4"];
          ids.forEach((id, idx) => {
            const row = state.placeholders[idx] || {};
            const textEl = document.getElementById(id + "-text");
            const selectEl = document.getElementById(id + "-source");
            if (textEl) textEl.value = row.text || "";
            if (selectEl && row.source) selectEl.value = row.source;
          });
        }
      } catch (e) {
        // ignore parse errors
      }
    }

    function collectPlaceholderConfig() {
      const configs = [];

      const rows = [
        { textId: "ph1-text", sourceId: "ph1-source" },
        { textId: "ph2-text", sourceId: "ph2-source" },
        { textId: "ph3-text", sourceId: "ph3-source" },
        { textId: "ph4-text", sourceId: "ph4-source" }
      ];

      for (const row of rows) {
        const textInput = document.getElementById(row.textId);
        const sourceSelect = document.getElementById(row.sourceId);

        const placeholder = (textInput.value || "").trim();
        if (!placeholder) {
          continue;
        }

        configs.push({
          placeholder: placeholder,
          source: sourceSelect.value
        });
      }

      return configs;
    }

    function showStatus(message, isError) {
      const statusEl = document.getElementById("status");
      statusEl.textContent = message || "";
      statusEl.className = "status " + (isError ? "error" : "ok");
    }

    function clearOutput() {
      const output = document.getElementById("output");
      output.innerHTML = "";
    }

    function createCodeBlockElement(content, index) {
      const wrapper = document.createElement("div");
      wrapper.className = "code-block";

      const header = document.createElement("div");
      header.className = "code-block-header";

      const titleSpan = document.createElement("span");
      titleSpan.textContent = "Codeblock " + (index + 1);

      const copyButton = document.createElement("button");
      copyButton.type = "button";
      copyButton.className = "copy-button";
      copyButton.textContent = "Kopieren";

      copyButton.addEventListener("click", () => {
        navigator.clipboard.writeText(content).then(() => {
          copyButton.textContent = "Kopiert";
          setTimeout(() => {
            copyButton.textContent = "Kopieren";
          }, 1200);
        }).catch(() => {
          copyButton.textContent = "Fehler";
          setTimeout(() => {
            copyButton.textContent = "Kopieren";
          }, 1200);
        });
      });

      header.appendChild(titleSpan);
      header.appendChild(copyButton);

      const pre = document.createElement("pre");
      const code = document.createElement("code");
      code.innerHTML = highlightStructuredText(content, { showWhitespace: false });
      pre.appendChild(code);

      wrapper.appendChild(header);
      wrapper.appendChild(pre);

      return wrapper;
    }

    const templateField = document.getElementById("template");
    const templateHighlight = document.getElementById("template-highlight");

    if (templateField && templateHighlight) {
      templateField.addEventListener("input", () => {
        updateTemplateHighlight();
        syncTemplateScroll();
        persistState();
      });

      templateField.addEventListener("scroll", syncTemplateScroll);
      templateField.addEventListener("keydown", (event) => {
        if ((event.ctrlKey || event.metaKey) && !event.altKey && !event.shiftKey) {
          const num = Number(event.key);
          if (Number.isInteger(num) && num >= 1 && num <= 4) {
            event.preventDefault();
            event.stopPropagation();
            insertSelectionIntoPlaceholder(num);
          }
        }
      });

      // Activate overlay styling once the highlighter is wired.
      templateField.classList.add("overlay-active");
    }

    // Restore saved state before initial highlight render
    restoreState();

    updateTemplateHighlight();
    syncTemplateScroll();

    let lastGenerated = [];

    document.getElementById("generate").addEventListener("click", () => {
      clearOutput();
      showStatus("", false);
      lastGenerated = [];

      const v1 = parseLines("variable_1");
      const v2 = parseLines("variable_2");
      const v3 = parseLines("variable_3");
      const v4 = parseLines("variable_4");

      const counts = [v1.length, v2.length, v3.length, v4.length];
      const nonZeroCounts = counts.filter(c => c > 0);

      if (nonZeroCounts.length === 0) {
        showStatus("Bitte in mindestens einem Variablenfeld Zeilen eintragen.", true);
        return;
      }

      const reference = nonZeroCounts[0];
      if (nonZeroCounts.some(c => c !== reference)) {
        showStatus("In allen ausgefüllten Variablenfeldern muss die gleiche Anzahl Zeilen stehen.", true);
        return;
      }
      const maxCount = Math.max.apply(null, counts);

      const template = (document.getElementById("template").value || "").trim();
      if (!template) {
        showStatus("Bitte einen Code im Editor eingeben.", true);
        return;
      }

      const configs = collectPlaceholderConfig();
      if (configs.length === 0) {
        showStatus("Bitte mindestens einen Platzhalter konfigurieren.", true);
        return;
      }

      if (configs.length > 4) {
        showStatus("Maximal vier Platzhalter sind erlaubt.", true);
        return;
      }

      const usedPlaceholders = new Set();
      for (const cfg of configs) {
        if (usedPlaceholders.has(cfg.placeholder)) {
          showStatus("Jeder Platzhalter darf nur einmal konfiguriert werden.", true);
          return;
        }
        usedPlaceholders.add(cfg.placeholder);
      }

      const vectors = {
        variable_1: v1,
        variable_2: v2,
        variable_3: v3,
        variable_4: v4
      };

      for (const cfg of configs) {
        if (!vectors[cfg.source]) {
          showStatus("Ungültige Quellvariable für Platzhalter " + cfg.placeholder + ".", true);
          return;
        }
      }

      const output = document.getElementById("output");
      lastGenerated = [];

      for (let i = 0; i < maxCount; i++) {
        let generated = template;

        for (const cfg of configs) {
          const sourceArray = vectors[cfg.source];
          const value = sourceArray[i] || "";
          generated = replaceAllLiteral(generated, cfg.placeholder, value);
        }

        lastGenerated.push(generated);
        const blockEl = createCodeBlockElement(generated, i);
        output.appendChild(blockEl);
      }

      showStatus(maxCount + " Codeblöcke wurden erzeugt.", false);
      persistState();
    });

    const copyAllButton = document.getElementById("copy-all");
    if (copyAllButton) {
      copyAllButton.addEventListener("click", () => {
        if (!lastGenerated.length) {
          showStatus("Noch keine Codeblöcke erzeugt.", true);
          return;
        }

        const all = lastGenerated.join("\n\n");
        navigator.clipboard.writeText(all).then(() => {
          showStatus("Alle Codeblöcke wurden kopiert.", false);
        }).catch(() => {
          showStatus("Konnte nicht in die Zwischenablage kopieren.", true);
        });
      });
    }

    const clearVarsButton = document.getElementById("clear-vars");
    if (clearVarsButton) {
      clearVarsButton.addEventListener("click", () => {
        ["variable_1", "variable_2", "variable_3", "variable_4"].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.value = "";
          }
        });
        persistState();
        showStatus("Variablenfelder geleert.", false);
      });
    }

    const clearEditorButton = document.getElementById("clear-editor");
    if (clearEditorButton) {
      clearEditorButton.addEventListener("click", () => {
        const templateEl = document.getElementById("template");
        if (templateEl) {
          templateEl.value = "";
        }
        updateTemplateHighlight();
        syncTemplateScroll();
        clearOutput();
        lastGenerated = [];
        persistState();
        showStatus("Editor und Ausgabe geleert.", false);
      });
    }

    // Persist variable and placeholder inputs
    ["variable_1", "variable_2", "variable_3", "variable_4",
      "ph1-text", "ph2-text", "ph3-text", "ph4-text"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input", persistState);
      }
    });

    ["ph1-source", "ph2-source", "ph3-source", "ph4-source"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("change", persistState);
      }
    });
  </script>
</body>
</html>
